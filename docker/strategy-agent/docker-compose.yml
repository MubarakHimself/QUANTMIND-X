# Docker Compose configuration for QuantMindX Strategy Agent
# Testing environment with Redis and security hardening

version: '3.8'

services:
  # Redis for event publishing and caching
  redis:
    image: redis:7-alpine
    container_name: quantmindx-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp

  # Strategy Agent (Paper Trading)
  strategy-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: quantmindx-strategy-agent
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      - PYTHONUNBUFFERED=1
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - AGENT_ID=strategy-agent-1
      - MT5_TERMINAL_PATH=/mt5/terminal64.exe
      - LOG_LEVEL=INFO
    volumes:
      # Mount logs and data directories (writable)
      - ./logs:/app/logs:rw
      - ./data:/app/data:rw
      # Mount MT5 terminal if available (read-only)
      - /mnt/mt5:/mt5:ro
    # Security hardening
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /app/tmp:rw,mode=1777
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
      restart_policy:
        condition: on-failure
        max_attempts: 3
    # PIDs limit to prevent fork bombs
    pids_limit: 100
    # Drop all capabilities except necessary ones
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    # Network isolation
    networks:
      - quantmindx-network
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

volumes:
  redis-data:
    driver: local

networks:
  quantmindx-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
